We're proud to announce the new feature release of darktable, 4.6.0!

The github release is here: [https://github.com/darktable-org/darktable/releases/tag/release-4.6.0](https://github.com/darktable-org/darktable/releases/tag/release-4.6.0).

As always, please don't use the autogenerated tarball provided by
github, but only our tar.xz file. The checksums are:

```
$ sha256sum darktable-4.6.0.tar.xz
??? darktable-4.6.0.tar.xz
$ sha256sum darktable-4.6.0-x86_64.dmg
??? darktable-4.6.0-x86_64.dmg
$ sha256sum darktable-4.6.0-arm64.dmg
??? darktable-4.6.0-arm64.dmg
$ sha256sum darktable-4.6.0-win64.exe
??? darktable-4.6.0.exe
```

When updating from the stable 4.2.x series, please bear in
mind that your edits will be preserved during this process, but the new
library and configuration will no longer be usable with 4.2.x.

You are strongly advised to take a backup first.

#### Important note: to make sure that darktable can keep on supporting the raw file format for your camera, *please* read [this post](https://discuss.pixls.us/t/raw-samples-wanted/5420?u=lebedevri) on how/what raw samples you can contribute to ensure that we have the *full* raw sample set for your camera under CC0 license!

Since darktable 4.4:

- ?? commits to darktable+rawspeed
- ?? pull requests handled
- ?? issues closed


_Please note that the darktable documentation is not currently complete for release 4.6
and contributions are greatly appreciated. Please see the
[project documentation](https://github.com/darktable-org/dtdocs#contributing)
for more information on how to contribute._

## The Big Ones

The following is a summary of the main features added to darktable
4.6. Please see the user manual for more details of the individual
changes (where available).

- While editing images the history is periodically saved. This is done
  every 10 seconds by default. The interval can be changed via the
  preferences or fully disabled if the interval is set to 0.

- New module, _rgb primaries_, can be used for delicate color corrections
  as well as creative color grading. It moves the red, green and blue
  primary colors around based on "hue" and "purity" parameters set by the
  user. The underlying pixel operation is the same as channel mixing.

- _sigmoid_ now features a _primaries_ section which can be used to
  handle difficult lighting (such as LEDs) gracefully and tune the overall
  look of the resulting image, allowing for pleasing sunsets, skin tones etc.
  The feature applies only to the per-channel mode. It is loosely based on
  ideas from Troy Sobotka's [AgX](https://github.com/sobotka/AgX-S2O3)
  and related work and discussions in the [Blender community](https://blenderartists.org/t/feedback-development-filmic-baby-step-to-a-v2/1361663). Preset "smooth",
  utilizing the new feature, is added to provide a good starting point.

- When panning or zooming, a low resolution placeholder used to be
  shown until the image was fully recalculated. Now the part of the
  previous high quality preview that is still visible is moved or
  resized and only the edges are temporarily shown in low quality.

  The full rework on the way the image is displayed has also removed
  some annoying jumps of the image when replacing the low resolution
  image by the final one or when switching between full and cropped
  view (when the crop, retouch or liquify modules are un/focused).

## Performance Improvements

- Initialize OpenCL in the background. Especially under Windows this
  can take a long time (>1 minute) when the OpenCL modules need to be
  (re)compiled, at first run or after driver updates. Nothing used to
  happen during that time, making it look like darktable failed to
  start. Now the UI comes up and reports progress in toast
  messages. Until OpenCL is fully available processing will be slower.

- Implemented OpenCL code for embedded lens corrections.

- Improve by 25% the display of the pictures on the map.

- Faster export of JPEG 2000 and B&W TIFF images.

## Other Changes

- Hotpixels module now also supports monochrome images.

- Retouch module do not need the internal guide widget, so it has been
  removed.

- Allow import session to be canceled by clicking on the cross in the
  progress bar on bottom left.

- Add support for auto orientation when importing AVIF/HEIF images
  (requires at least libavif 0.9.2 and/or libheif 1.16.0).

- Tune CA correct module performances (gain about 10% on CPU).

- Rastermasks are visualized the same way as other masks in the module
  header and via the mask visualize button.

- Improved dual demosaicing mask visualizing and performance.

- A manually controlled vignette correction has been added tot the
  lens module.

- Always show the full uncropped image with cropping rectangle as a
  marker while working in liquify and retouch modules.

- Add linear ProPhoto RGB as possible LUT color-space.

- A set of changes done on OpenCL support:

  - Removed the benchmarking code from opencl as it didn't produce valid
    results on today's computers.

  - Removed the preference option to select pinned memory transfer. Can
    be selected on a per device basis.

  - Usage of "headroom" can be selected in preferences, the default
    has been increased to 600Mb as more systems use graphics memory
    nowadays.

  - Introduce selection of wanted OpenCL drivers in preferences.

- Add Display P3 built-in color profile for input, output, display,
  working and soft-proofing.

- The highlights module is now made available for all non-raw files.

- The speed of scrolling through the filmstrip can be increased by
  holding <kbd>shift</kbd>; you will move by half of the visible
  images at a time. Holding <kbd>ctrl</kbd> while scrolling changes
  the number of images shown ("zooms") and thereby the shift speed.

- Exported AVIF files no longer embed a superfluous ICC profile if the
  color profile can be encoded as CICP (Coding-independent code
  points).

- Exported PNG files now include a CICP (Coding-independent code
  points) encoded color profile in addition to ICC if possible.

- Improved scaling and placement of images in culling view to make
  better use of available screen space.

- When hovering the sample patches in the global color picker module
  the areas are displayed on the central area and on the histogram (if
  the corresponding option is selected). It is not necessary anymore
  to have the color-picker activated. This enhanced behavior comes
  handy when doing color grading for example.

- A function dt_bauhaus_widget_set_quad_tooltip was added that allows
  setting a separate tooltip for the button linked to a slider or
  dropdown (commonly color pickers).

- Holding the <kbd>ctrl</kbd> key while double clicking a slider or
  combo, which normally resets it to its default value, instead
  restores the auto-applied preset for processing modules (if a preset
  is marked as such).

- When multiple mask shapes are combined, in the popup menu for a
  shape a tick mark is shown in front of the active combine mode,
  which can be easier to read than the icon in front of the shape.

- Added mnemonics to dialog box buttons and marked default buttons so
  pressing <kbd>Enter</kbd> will trigger them and close the dialog.

- Extract more OpenEXR 3.2.0 attributes for image information if
  present.

- Add lens and cameras filters to the filtering module.

- AVIF export changes: no conversion to YUV for lossless, update
  quantizer selection logic and make lossy default.

- The generation of the preference dialog now takes the specification
  of tabs and sections from darktable.xml.in too, so almost the
  complete layout can be changed by just editing that file.

- Changed the preference dialog dropdowns to use bauhaus widgets so it
  conforms to (and offers the same behavior) as widgets in the rest of
  the program.

- Improved numbers precision in configuration system.

- Rework the collection module to be consistent about sorting. All
  date/time can be reversed (older or newer first). Also the folder
  can be reversed when sorted according to their id
  (chronological). The preference has been renamed from id to
  chronological for clarity.

  The collection based on rating now use proper text like rejected
  instead of -1 and the numbers are replaced by stars.

  The color label collection now displays the color in the same order
  as in all other part of the GUI.

- Preference setting "after edit" for writing sidecar files now
  accepts also adding a tag as a valid user edit.

- Added a thumbnail generating background job.

  While the user is inactive in lighttable mode a background crawler
  job generates thumbnails - as done via darktable-generate-cache. The
  requested thumbnail size is defined via a preferences setting
  defaulting to "never".

- Two new variables have been introduced to get the camera crop factor
  "EXIF.CROP_FACTOR" and the corresponding 35mm equivalent focal
  length "EXIF.FOCAL.LENGTH.EQUIV".

- The harmony guides are now saved and restored for every image as for
  all other image's properties. Going back to a previous edit it is
  not necessary anymore to set the harmony guides again. And since
  the information is saved in the XMP it can be passed over when
  sharing pictures or restored when re-importing a collection.

- Added control over chroma subsampling in JPEG export.

  This allows the user to reduce the color resolution and export in
  most cases much smaller files that will be indistinguishable to the
  human eye from images with more color information.

  On the other hand, there are certain images that will look better
  when the chroma resolution is maximized. These are images that
  include small colored details surrounded by a solid background (such
  as screenshots with colored text or photos of the like).

- The option to ignore only JPEG files when importing (which is
  outdated in the days when some cameras can also shoot in HEIF) has
  been changed to the option to ignore all non-raw files.

- The lens correction module now supports embedded metadata in Olympus
  .ORF files for correction of distortion and chromatic aberration.

  The correction is equivalent to that applied by the camera body to
  in-camera JPEGs. For older bodies which do not apply chromatic
  aberration correction to the JPEGs, it is also not included in the
  embedded metadata.

  Vignetting correction based on embedded metadata is not supported.
  If the camera's Shading Compensation option is enabled then the
  vignetting correction will already be applied to the data in the raw
  file.

- The shortcuts system received several refinements:

  - Deleting or overwriting a default shortcut moves it to the
    "disabled defaults" category from where it can restored by
    pressing <kbd>Delete</kbd>. It is no longer necessary to uncheck
    "load default shortcuts at startup" (in prefs/misc/interface) to
    keep it disabled.

  - Visual mapping mode has better mouse cursors to indicate whether
    the widget under the cursor can have a shortcut or be added to (or
    removed from) the quick access panel.

  - The shortcuts preference tab now explains that it may be more
    convenient to use visual mapping mode.

  - When combining a shortcut with a move (for example
    <kbd>b+scroll</kbd>) separate actions can be triggered by up and
    down moves. <kbd>b+scroll</kbd> up could cycle through the top
    panel options and b+scroll down through the bottom panel
    combinations.

  - A problem with dropdown and slider popups opened via a shortcut
    was fixed. They would immediately fill with the shortcut key
    character. Now those popups are integrated into the shortcut
    system, so most non-alphanumeric shortcuts continue to work. If a
    dropdown value is changed while the popup is open (for example via
    a calculation AI detection in color calibration), Lua script or
    midi shortcut, the popup is correctly updated/repositioned. After
    a popup is closed it can quickly be reopened to enter another
    value by pressing <kbd>Enter</kbd> (as long as the corresponding
    widget still has focus).

- The color assessment mode ("white borders") for the secondary
  preview window is now activated independently from the main window
  (and saved between sessions) with a toggle in the
  <kbd>right-click</kbd> popover of the "display second window" button
  (or using the default <kbd>alt+b</kbd> shortcut).

## Bug Fixes

- Fixes OpenCL platform checking which could lead to a freeze of
  darktable.

- Fix the calculation of resizable widgets based on line size of
  contents.

- Fixed a bug in the collection filter module where the conjunction of
  multiple filters were not handled properly.

- Fix focus distance detection for Nikon Z mount lens corrections.

- Fixed wrong cropping of sensor data for sraw dng files.

- Apply the Lr color matrix only when importing a genuine Lr XMP.

- Fix a crash when increasing the number of recent collections.

- Fix crash when clicking & dragging the feather line on the path
  mask.

- Fixed crash when applying CMYK soft-proof ICC profile.

- The white borders for ISO 12464 color assessment (toggled with
  <kbd>Ctrl</kbd>+B</kbd>) are now correctly sized and placed at all
  zoom levels and don't flash when switching between low and high
  quality preview, both in the center view and secondary preview
  window.

- Fix issue downloading to Piwigo when on conflict option is set to
  "don't check".

- Fixed several mouse scroll wheel issues on macOS in combination with
  the <kbd>shift</kbd> modifier key, i.e.: Color harmonies width,
  module height, geotagging date/time.

- Fixing a bug for duplicate xmp sidecars making sure it has not been
  used before across different databases.

- For large collections on the lighttable and when using small
  thumbnails (more than 15 per line) using the scrollbar or scrolling
  the mouse to move donw or up may be slow. This has been improved
  drastically. The lighttable has been tested with more than 50k and
  20 thumbnails per line to be fast and responsive.

- Fixed pixel errors in RAW Chromatic Aberration and LMMSE demosaic
  resulting in less noise.

- Fixed 'Avoid colorshift' mode in RAW Chromatic Aberration.

- Make sure that snapshot for removed images are not accessible
  anymore. It was not the case and trying to display a snapshot based
  on a removed image crashed darktable.

- Fix a potential crash when using a non supported ICC profile for
  soft-proof.

- Fix multiple small precision issues when computing the borders in the
  Framing module. For a 0% border on the right or the bottom sides
  there was some time a one pixel border. This was dependent on the
  actual export size or zoom level in darkroom.

  Also a 0% border doesn't mean no border at all if the border's
  aspect ratio chosen doesn't correspond to the image aspect.

- The tone equalizer internal luminance mask has been made more
  resilient to distortion changes make with modules like lens
  correction, crop, etc. After activating a crop, the tone equalizer
  picker will display the proper luminance values when flying over the
  picture in darkroom center area.

- Fixed calculation of required graphics memory for modules doing
  blending possibly avoiding crashes related to OpenCL.

- Added the ability to calculate the crop factor for those cameras
  that do not contain this information in the metadata.

- Fixed various bugs related to feathering masks.

## Lua

### API Version

- API version is now 9.2.0

### Bug Fixes

- Fixed scripts_installer to handle user names with spaces on Windows.

### Add action support for Lua


### Other Lua changes

- Allow access to image change_timestamp.

## Notes

- When exporting to AVIF, EXR, JPEG XL, or XCF, selecting specific
  metadata (e.g. geo tag or creator) is not currently possible. For
  AVIF, EXR, JPEG XL, and XCF formats, darktable will not include any
  metadata fields unless the user selects all of the checkboxes in the
  export preference options.

- In order to support the correct display of numbers in darktable, the
  minimum supported Gtk version has had to be increased to
  3.24.15. For people who need to build darktable with an older
  version, this can be achieved by removing line 241 of the
  `darktable.css` file on your system. See
  https://github.com/darktable-org/darktable/issues/13166.

- Starting with release 4.4 a new support policy regarding macOS
  versions has been put in place -- darktable releases will now only
  support those macOS versions that are also supported by Apple.
  Release 4.6 therefore drops support for macOS versions older than
  11.3.

## Changed Dependencies

### Mandatory

- ???

### Optional

- Bump libavif to 0.9.2

## RawSpeed changes


## Camera support, compared to 4.2

### Base Support


### White Balance Presets


### Noise Profiles


### Missing Compression Mode Support

- Apple ProRAW DNGs
- CinemaDNG lossless (Blackmagic, DJI, etc.)
- Fujifilm lossy RAFs
- Nikon high efficiency NEFs
- Samsung Expert RAW DNGs
- Sony downsized lossless ARWs ("M" for full-frame, "S" for full-frame & APS-C)

### Suspended Support

Support for the following cameras is suspended because no samples
are available on raw.pixls.us:

- Creo/Leaf Aptus 22(LF3779)/Hasselblad H1
- Fujifilm FinePix S9600fd
- Fujifilm IS-1
- GoPro FUSION
- Kodak EasyShare Z980
- Leaf Aptus-II 5(LI300059)/Mamiya 645 AFD
- Leaf Credo 60
- Leaf Credo 80
- Minolta DiMAGE 5
- Olympus SP320
- Panasonic DMC-FX150
- Pentax Q10
- Phase One IQ250
- Samsung EK-GN120
- Sinar Hy6/ Sinarback eXact
- ST Micro STV680

## Translations

- ???
